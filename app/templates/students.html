
<!-- students.html -->
{% block content %}
{% include "modals/studentModals.html" %}

<!-- Static Body Content -->
<!-- Students -->
<div class="container-fluid">
    <div class="row">
        <div class="col-sm-2"></div>
        <!-- content goes here -->
        <div class="col-sm-8">
            <h2>Student List <button class="btn btn-primary float-end" data-toggle="modal"
                    data-target="#myStudentModal">Add
                    Student</button></h2>

            {%with messages = get_flashed_messages()%}
            {%if messages%}
            {% for message in messages %}

            <div class="alert alert-success alert-dismissable" role="alert">
                <button type="button" class="close" data-dismiss="alert" aria-label="close">
                    <span aria-hidden="true">&times;</span>
                </button>
                {{message}}
            </div>

            {%endfor%}
            {%endif%}
            {%endwith%}
            <div class="table-container">
                <table class="table table-hover students-table">
                    <thead>
                        <tr>
                            <th scope="col">ID</th>
                            <th scope="col">First Name</th>
                            <th scope="col">Last Name</th>
                            <th scope="col">Course Code</th>
                            <th scope="col">Year Level</th>
                            <th scope="col">Gender</th>
                            <th scope="col">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for student in students %}
                        <tr>
                            <td>{{ student[0] }}</td>
                            <td>{{ student[1] }}</td>
                            <td>{{ student[2] }}</td>
                            <td>{{ student[3] }}</td>
                            <td>{{ student[4] }}</td>
                            <td>{{ student[5] }}</td>
                            <td>
                                <a href="#" class="btn btn-warning btn-sm edit-btn" data-toggle="modal"
                                    data-target="#editStudentModal" data-id="{{ student[0] }}">Edit</a>
                                <form class="delete-form d-inline" action="{{ url_for('students.delete_student', id=student[0]) }}" method="POST">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
</div>
<!-- END OF STUDENTS -->

<!-- Scripts -->

<script>
    $("#addStudentForm").on('submit', function(e) {
        e.preventDefault();
        $.ajax({
            url: $(this).attr('action'),
            type: 'POST',
            data: $(this).serialize(),
            success: function(response) {
                if (response.success) {
                    $("#students-tab-pane").load("/students/");
                    $('body').removeClass('modal-open');
                    $('.modal-backdrop').remove();
                } else {
                    alert(response.message);
                }
            }
        });
    });     
</script>

<script>
    $("#editStudentForm").on('submit', function(e) {
        e.preventDefault();
        var form = $(this);
        var formData = form.serialize();
    
        $.ajax({
            url: form.attr('action'),
            type: "POST",
            data: formData,
            success: function(response) {
                if (response.success) {
                    $("#students-tab-pane").load("/students/");
                    $('body').removeClass('modal-open');
                    $('.modal-backdrop').remove();
                } else {
                    alert(response.message);
                }
            },
            error: function(jqXHR, textStatus, errorThrown) {
                console.error("AJAX request failed: ", textStatus, errorThrown);
            }
        });
    });
    
    $('#editStudentModal').on('hidden.bs.modal', function (e) {
        $('body').removeClass('modal-open');
        $('.modal-backdrop').remove();
    });

    $('.students-table').on('click', '.edit-btn', function() {
        var row = $(this).closest('tr');
        
        // Get the current data of the student from the DOM
        var id = row.find('td:nth-child(1)').text();
        var firstName = row.find('td:nth-child(2)').text();
        var lastName = row.find('td:nth-child(3)').text();
        var courseCode = row.find('td:nth-child(4)').text();
        var yearLevel = row.find('td:nth-child(5)').text();
        var gender = row.find('td:nth-child(6)').text();
        
        // Populate the fields of the edit form with the current data of the student
        $('#editStudentModal input[name="id"]').val(id);
        $('#editStudentModal input[name="old_id"]').val(id);
        $('#editStudentModal input[name="firstName"]').val(firstName);
        $('#editStudentModal input[name="lastName"]').val(lastName);
        $('#editStudentModal select[name="courseCode"]').val(courseCode);
        $('#editStudentModal input[name="yearLevel"]').val(yearLevel);
        
        // Select the correct gender radio button
        if (gender === 'Male') {
            $('#editStudentModal #male').prop('checked', true);
        } else if (gender === 'Female') {
            $('#editStudentModal #female').prop('checked', true);
        }
    
        // Show the modal after the form fields have been populated
        $('#editStudentModal').modal('show');
    });
</script>

<script>
    function updateStudentsTable() {
        $.get('/students/', function(data) {
            // Replace the current table with the updated one
            $('#studentsTable').replaceWith($(data).find('#studentsTable'));
        });
    }
</script>

<script>
    $(".delete-form").on('submit', function(e) {
        e.preventDefault();
        var form = $(this);
        $.ajax({
            url: form.attr('action'),
            type: 'POST',
            data: form.serialize(),
            success: function(response) {
                if (response.success) {
                    $("#students-tab-pane").load("/students/");
                } else {
                    alert(response.message);
                }
            }
        });
    });
</script>


{% endblock %}